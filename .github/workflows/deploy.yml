name: Backend Deploy

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # dev branch --> staging
    # main branch --> production
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node (Local)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create Artifact
        run: tar -czf backend.tgz --exclude='backend.tgz' --exclude='node_modules' --exclude='.git' --exclude='.env' .

      - name: Upload to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "backend.tgz"
          target: "/tmp"

      - name: Install & Restart
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e

            TARGET="${{ vars.BACKEND_PATH }}"
            PM2_NAME="${{ vars.PM2_NAME }}"

            if [ -z "$TARGET" ] || [ -z "$PM2_NAME" ]; then
              echo "Error: Missing GitHub Variables (BACKEND_PATH or PM2_NAME)"
              exit 1
            fi

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo "Deploying to: $TARGET"
            echo "Process Name: $PM2_NAME"

            mkdir -p "$TARGET"
            tar -xzf /tmp/backend.tgz -C "$TARGET"

            cd "$TARGET"
            echo "Installing Dependencies..."
            npm ci --production

            pm2 reload "$PM2_NAME" || pm2 start npm --name "$PM2_NAME" -- start
            pm2 save
  
            rm -f /tmp/backend.tgz
            echo "Backend Deployment Complete!"